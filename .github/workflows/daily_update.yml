name: Aktualizacja Historii FRA
on:
  schedule:
    # 07:00 UTC = 08:00/09:00 PL
    # 14:00 UTC = 15:00/16:00 PL
    - cron: '0 7 * * *'
    - cron: '0 14 * * *'
  workflow_dispatch:

jobs:
  update_history:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ustawienie Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Pobieranie danych i aktualizacja JSON
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. Pobieranie treści stron do plików
          curl -s -L -A "Mozilla/5.0" https://www.patria.cz/kurzy/EUR/3x6/fra/graf.html > t3.txt
          curl -s -L -A "Mozilla/5.0" https://www.patria.cz/kurzy/EUR/6x9/fra/graf.html > t6.txt
          curl -s -L -A "Mozilla/5.0" https://www.patria.cz/kurzy/EUR/9x12/fra/graf.html > t9.txt
          
          # 2. Skrypt Node.js (bez zewnętrznych bibliotek)
          node -e "
          const fs = require('fs');
          
          async function run() {
            try {
              // Wczytanie plików
              const t3 = fs.readFileSync('t3.txt', 'utf8').substring(0, 8000);
              const t6 = fs.readFileSync('t6.txt', 'utf8').substring(0, 8000);
              const t9 = fs.readFileSync('t9.txt', 'utf8').substring(0, 8000);
              
              // Wczytanie historii (jeśli brak, to pusta lista)
              let history = [];
              if (fs.existsSync('data.json')) {
                 try { history = JSON.parse(fs.readFileSync('data.json', 'utf8')); } catch (e) { history = []; }
              }

              // Treść zapytania do API
              const payload = {
                contents: [{
                  parts: [{
                    text: \`Jesteś precyzyjnym parserem danych. 
                    Twoim zadaniem jest znalezienie liczby przy etykiecie 'Aktuální hodnota' w trzech fragmentach kodu HTML.
                    
                    HTML 3x6: \${t3}
                    HTML 6x9: \${t6}
                    HTML 9x12: \${t9}
                    
                    Zwróć JEDEN obiekt JSON (bez znaczników markdown) w formacie:
                    {
                      \"date\": \"\${new Date().toLocaleString('pl-PL')}\",
                      \"v3x6\": \"(tutaj liczba)\",
                      \"v6x9\": \"(tutaj liczba)\",
                      \"v9x12\": \"(tutaj liczba)\"
                    }\`
                  }]
                }],
                generationConfig: {
                  response_mime_type: 'application/json'
                }
              };

              // Bezpośrednie uderzenie do API (omijamy bibliotekę)
              const response = await fetch(
                'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + process.env.GEMINI_API_KEY,
                {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                }
              );

              if (!response.ok) {
                throw new Error(\`API Error: \${response.status} \${response.statusText}\`);
              }

              const data = await response.json();
              // Wyciąganie tekstu z odpowiedzi Google
              const rawText = data.candidates[0].content.parts[0].text;
              const newData = JSON.parse(rawText);

              // Dopisanie do historii i zapis
              history.push(newData);
              fs.writeFileSync('data.json', JSON.stringify(history, null, 2));
              console.log('SUKCES! Dodano dane:', newData);

            } catch (err) {
              console.error('BŁĄD KRYTYCZNY:', err);
              process.exit(1);
            }
          }
          run();
          "

      - name: Zapisanie zmian w repozytorium
        run: |
          git config --global user.name "FRA-Bot"
          git config --global user.email "bot@github.com"
          git add data.json
          git commit -m "Aktualizacja JSON: $(date)" || exit 0
          git push
