name: Aktualizacja Historii FRA
on:
  schedule:
    # 08:00 i 15:00 UTC (czyli 9:00 i 16:00 w PL)
    - cron: '0 8 * * *'
    - cron: '0 15 * * *'
  workflow_dispatch:

jobs:
  update_history:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ustawienie Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Pobieranie danych
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. Instalujemy to narzędzie, które masz na komputerze (CLI)
          npm install -g gemini-chat-cli

          # 2. Pobieramy strony do plików (udając przeglądarkę)
          curl -s -L -A "Mozilla/5.0" https://www.patria.cz/kurzy/EUR/3x6/fra/graf.html > t3.txt
          curl -s -L -A "Mozilla/5.0" https://www.patria.cz/kurzy/EUR/6x9/fra/graf.html > t6.txt
          curl -s -L -A "Mozilla/5.0" https://www.patria.cz/kurzy/EUR/9x12/fra/graf.html > t9.txt
          
          # 3. Sprawdzamy czy plik historii istnieje, jak nie to tworzymy pusty
          if [ ! -f data.json ]; then echo "[]" > data.json; fi

          # 4. Magia: Używamy CLI dokładnie tak jak Ty lokalnie
          # Łączymy wszystko w jedno polecenie, żeby Gemini dostało pełny kontekst
          
          gemini "Jesteś parserem JSON. Masz plik data.json: $(cat data.json). 
          Oraz nowe dane HTML: 
          3x6: $(cat t3.txt | head -c 2000) 
          6x9: $(cat t6.txt | head -c 2000) 
          9x12: $(cat t9.txt | head -c 2000). 
          
          Twoje zadanie:
          1. Wyciągnij liczbę 'Aktuální hodnota' z każdego HTML.
          2. Stwórz nowy obiekt: { \"date\": \"$(date +'%Y-%m-%d %H:%M')\", \"v3x6\": \"WARTOŚĆ\", \"v6x9\": \"WARTOŚĆ\", \"v9x12\": \"WARTOŚĆ\" }.
          3. Dodaj go do listy z data.json.
          4. Wypisz TYLKO poprawny kod JSON całej listy (bez markdown, bez \`\`\`)." > temp_data.json

          # Zabezpieczenie: jeśli plik jest pusty (błąd API), nie nadpisujemy
          if [ -s temp_data.json ]; then
            mv temp_data.json data.json
            echo "Sukces! Zaktualizowano data.json"
          else
            echo "Błąd: Gemini zwróciło pusty wynik."
            exit 1
          fi

      - name: Zapisanie zmian w repozytorium
        run: |
          git config --global user.name "FRA-Bot"
          git config --global user.email "bot@github.com"
          git add data.json
          git commit -m "Nowy kurs: $(date)" || exit 0
          git push
