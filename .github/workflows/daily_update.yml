name: Aktualizacja Historii FRA
on:
  schedule:
    # 08:00 i 15:00 UTC (9:00 i 16:00 w PL)
    - cron: '0 8 * * *'
    - cron: '0 15 * * *'
  workflow_dispatch:

jobs:
  update_history:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ustawienie Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Pobieranie danych i aktualizacja JSON
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # 1. Pobieranie stron (udając przeglądarkę)
          curl -s -L -A "Mozilla/5.0" https://www.patria.cz/kurzy/EUR/3x6/fra/graf.html > t3.txt
          curl -s -L -A "Mozilla/5.0" https://www.patria.cz/kurzy/EUR/6x9/fra/graf.html > t6.txt
          curl -s -L -A "Mozilla/5.0" https://www.patria.cz/kurzy/EUR/9x12/fra/graf.html > t9.txt
          
          # 2. Upewnienie się, że plik historii istnieje
          if [ ! -f data.json ]; then echo "[]" > data.json; fi

          # 3. Skrypt Node.js (BEZ INSTALOWANIA NICZEGO)
          # Używamy wbudowanego 'fetch' do połączenia z Google
          node -e "
          const fs = require('fs');
          
          async function run() {
            try {
              // Czytamy pliki i przycinamy je (optymalizacja)
              const t3 = fs.readFileSync('t3.txt', 'utf8').substring(0, 5000);
              const t6 = fs.readFileSync('t6.txt', 'utf8').substring(0, 5000);
              const t9 = fs.readFileSync('t9.txt', 'utf8').substring(0, 5000);
              
              // Czytamy historię
              let history = [];
              try { history = JSON.parse(fs.readFileSync('data.json', 'utf8')); } catch (e) { history = []; }

              // Przygotowanie zapytania do API
              const prompt = \`Jesteś parserem danych. 
              Przeanalizuj te fragmenty HTML i znajdź liczbę przy 'Aktuální hodnota'.
              HTML1: \${t3}
              HTML2: \${t6}
              HTML3: \${t9}
              
              Zwróć JEDEN obiekt JSON w formacie:
              { \"date\": \"\${new Date().toLocaleString('pl-PL')}\", \"v3x6\": \"WARTOŚĆ1\", \"v6x9\": \"WARTOŚĆ2\", \"v9x12\": \"WARTOŚĆ3\" }
              WAŻNE: Nie używaj formatowania Markdown (backticks). Zwróć czysty tekst JSON.\`;

              // Bezpośrednie uderzenie do API (to eliminuje błędy bibliotek)
              const response = await fetch(
                'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=' + process.env.GEMINI_API_KEY,
                {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }]
                  })
                }
              );

              if (!response.ok) throw new Error(\`Błąd API: \${response.status}\`);

              const data = await response.json();
              // Parsowanie odpowiedzi (czyszczenie ewentualnych znaczników kodu)
              let rawText = data.candidates[0].content.parts[0].text;
              rawText = rawText.replace(/\\\`\\\`\\\`json/g, '').replace(/\\\`\\\`\\\`/g, '').trim();
              
              const newEntry = JSON.parse(rawText);

              // Zapisanie wyniku
              history.push(newEntry);
              fs.writeFileSync('data.json', JSON.stringify(history, null, 2));
              console.log('SUKCES! Dodano:', newEntry);

            } catch (err) {
              console.error('BŁĄD KRYTYCZNY:', err);
              process.exit(1);
            }
          }
          run();
          "

      - name: Zapisanie zmian w repozytorium
        run: |
          git config --global user.name "FRA-Bot"
          git config --global user.email "bot@github.com"
          git add data.json
          git commit -m "Nowy wpis: $(date)" || exit 0
          git push
