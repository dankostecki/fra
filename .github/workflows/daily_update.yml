name: Aktualizacja Historii FRA
on:
  schedule:
    # 07:00 UTC = 08:00 lub 09:00 PL (zależnie od czasu letniego/zimowego)
    # 14:00 UTC = 15:00 lub 16:00 PL
    - cron: '0 7 * * *'
    - cron: '0 14 * * *'
  workflow_dispatch: # Przycisk do ręcznego uruchomienia

jobs:
  update_history:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ustawienie Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Pobieranie danych i aktualizacja JSON
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          # Instalacja biblioteki
          npm install @google/generative-ai
          
          # Pobieranie stron (User-Agent udaje przeglądarkę)
          curl -s -L -A "Mozilla/5.0" https://www.patria.cz/kurzy/EUR/3x6/fra/graf.html > t3.txt
          curl -s -L -A "Mozilla/5.0" https://www.patria.cz/kurzy/EUR/6x9/fra/graf.html > t6.txt
          curl -s -L -A "Mozilla/5.0" https://www.patria.cz/kurzy/EUR/9x12/fra/graf.html > t9.txt
          
          # Skrypt przetwarzający
          node -e "
          const fs = require('fs');
          const { GoogleGenerativeAI } = require('@google/generative-ai');
          
          async function run() {
            try {
              const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);
              const model = genAI.getGenerativeModel({ 
                model: 'gemini-1.5-flash',
                generationConfig: { responseMimeType: 'application/json' }
              });
              
              // Czytanie historii lub tworzenie nowej listy
              let history = [];
              if (fs.existsSync('data.json')) {
                try {
                  history = JSON.parse(fs.readFileSync('data.json', 'utf8'));
                } catch(e) { history = []; }
              }

              const t3 = fs.readFileSync('t3.txt', 'utf8').substring(0, 5000);
              const t6 = fs.readFileSync('t6.txt', 'utf8').substring(0, 5000);
              const t9 = fs.readFileSync('t9.txt', 'utf8').substring(0, 5000);
              
              const prompt = \`Jesteś ekstraktorem danych. Wyciągnij wartość 'Aktuální hodnota' z trzech tekstów HTML:
              3x6: \${t3}
              6x9: \${t6}
              9x12: \${t9}
              
              Zwróć JEDEN obiekt JSON z polami: 'date' (aktualna data i godzina), 'v3x6', 'v6x9', 'v9x12'.
              Wartości muszą być liczbami.\`;
              
              const result = await model.generateContent(prompt);
              const newData = JSON.parse(result.response.text());
              
              // Dodanie do historii i zapis
              history.push(newData);
              fs.writeFileSync('data.json', JSON.stringify(history, null, 2));
              
              console.log('Nowe dane dopisane:', newData);
            } catch (err) {
              console.error('BŁĄD:', err);
              process.exit(1);
            }
          }
          run();
          "

      - name: Zapisanie zmian w repozytorium
        run: |
          git config --global user.name "FRA-Bot"
          git config --global user.email "bot@github.com"
          git add data.json
          git commit -m "Aktualizacja JSON: $(date)" || exit 0
          git push
